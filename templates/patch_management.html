<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Patch Management | Server Health Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { background-color: #f8f9fa; }
    .table-wrap { background: #fff; border-radius: 8px; padding: 16px; margin-top: 20px; }
    .status-ok { color: green; font-weight: 600; }
    .status-fail { color: #d63333; font-weight: 600; }
    .status-patched { color: #0d6efd; font-weight: 600; }
    .status-pending { color: #6c757d; font-weight: 600; }
    .spinner-border-sm { width: 1rem; height: 1rem; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <button class="btn btn-dark me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="navbar-brand">Patch Management</span>
      <div class="ms-auto d-flex align-items-center">
        {% if username %}
          <span class="navbar-text text-light me-3">Signed in as {{ username }}</span>
        {% endif %}
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Sidebar Menu -->
  <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header border-bottom">
      <h5 class="offcanvas-title">Menu</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-white" href="{{ url_for('dashboard') }}"><i class="bi bi-house me-2"></i>Dashboard</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-white" href="{{ url_for('inventory') }}"><i class="bi bi-box-seam me-2"></i>Inventory</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link active text-info" href="#"><i class="bi bi-wrench-adjustable-circle me-2"></i>Patch Management</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-white" href="{{ url_for('log_history') }}"><i class="bi bi-clock-history me-2"></i>Log History</a>
        </li>
        <li><hr class="text-secondary"></li>
        <li class="nav-item">
          <a class="nav-link text-danger" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
        </li>
      </ul>
    </div>
  </div>

  <div class="container my-4">
    <h4>Patch Management</h4>
    <p class="text-muted">Select hosts from your <strong>current upload ({{ upload.filename if upload else 'N/A' }})</strong> to check connectivity and trigger patch actions.</p>

    {% if not hosts or hosts|length == 0 %}
      <div class="alert alert-warning">No hosts available. Please upload a file from the dashboard.</div>
    {% else %}
    <div class="card table-wrap">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <button id="selectAllBtn" class="btn btn-outline-secondary btn-sm">Select All</button>
        </div>
        <div class="d-flex gap-2">
          <button id="checkBtn" class="btn btn-success btn-sm">Connectivity Check</button>
          <div id="checkSpinner" class="spinner-border spinner-border-sm text-success" style="display:none"></div>
          <button id="patchBtn" class="btn btn-primary btn-sm" disabled>Trigger Patch</button>
          <div id="patchSpinner" class="spinner-border spinner-border-sm text-primary" style="display:none"></div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-sm" id="hostsTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>ID</th>
              <th>Host</th>
              <th>SSH User</th>
              <th>PEM Path</th>
              <th>Status</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            {% for h in hosts %}
              <tr data-id="{{ h.id }}">
                <td><input type="checkbox" class="hostCheck"></td>
                <td>{{ h.id }}</td>
                <td>{{ h.host }}</td>
                <td>{{ h.ssh_user or '' }}</td>
                <td>{{ h.pem_path or '' }}</td>
                <td class="status status-pending">{{ h.status }}</td>
                <td class="message text-muted">{{ h.message or '' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const checkBtn = document.getElementById("checkBtn");
    const patchBtn = document.getElementById("patchBtn");
    const selectAll = document.getElementById("selectAll");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const checkSpinner = document.getElementById("checkSpinner");
    const patchSpinner = document.getElementById("patchSpinner");
    const hostCheckboxes = document.querySelectorAll(".hostCheck");

    // Select All functionality
    selectAll?.addEventListener("change", () => {
      hostCheckboxes.forEach(cb => cb.checked = selectAll.checked);
    });
    selectAllBtn?.addEventListener("click", () => {
      const allChecked = Array.from(hostCheckboxes).every(cb => cb.checked);
      hostCheckboxes.forEach(cb => cb.checked = !allChecked);
      selectAll.checked = !allChecked;
    });

    function getSelectedHosts() {
      return Array.from(document.querySelectorAll(".hostCheck"))
        .filter(cb => cb.checked)
        .map(cb => cb.closest("tr").dataset.id);
    }

    // --- Connectivity Check ---
    checkBtn?.addEventListener("click", async () => {
      const selected = getSelectedHosts();
      if (selected.length === 0) return alert("Select at least one host.");
      checkBtn.disabled = true; checkSpinner.style.display = "inline-block";
      patchBtn.disabled = true;
      try {
        const form = new FormData();
        for (const id of selected) form.append("host_ids[]", id);
        const resp = await fetch("{{ url_for('patch_check') }}", { method: "POST", body: form });
        const data = await resp.json();

        data.results.forEach(r => {
          const row = document.querySelector(`tr[data-id='${r.id}']`);
          if (row) {
            const statusTd = row.querySelector(".status");
            const msgTd = row.querySelector(".message");
            statusTd.textContent = r.ok ? "connected" : "failed";
            statusTd.className = r.ok ? "status status-ok" : "status status-fail";
            msgTd.textContent = r.msg;
          }
        });

        // enable patch button only if all selected are connected
        const allConnected = data.results.every(r => r.ok);
        if (allConnected) {
          patchBtn.disabled = false;
        } else {
          patchBtn.disabled = true;
          alert("Some hosts failed connectivity. Patch disabled until all selected are connected.");
        }
      } catch (err) {
        console.error("Error:", err);
        alert("Connectivity check failed.");
      } finally {
        checkBtn.disabled = false; checkSpinner.style.display = "none";
      }
    });

    // --- Trigger Patch ---
    patchBtn?.addEventListener("click", async () => {
      const selected = getSelectedHosts();
      if (selected.length === 0) return alert("Select hosts to patch.");
      if (!confirm("Proceed with patching selected hosts?")) return;
      patchBtn.disabled = true; patchSpinner.style.display = "inline-block";

      try {
        const form = new FormData();
        for (const id of selected) form.append("host_ids[]", id);
        const resp = await fetch("{{ url_for('trigger_patch') }}", { method: "POST", body: form });
        const data = await resp.json();

        data.results.forEach(r => {
          const row = document.querySelector(`tr[data-id='${r.id}']`);
          if (row) {
            const statusTd = row.querySelector(".status");
            const msgTd = row.querySelector(".message");
            statusTd.textContent = r.ok ? "patched" : "failed";
            statusTd.className = r.ok ? "status status-patched" : "status status-fail";
            msgTd.textContent = r.msg;
          }
        });

        alert("Patch process complete.");
      } catch (err) {
        console.error("Patch error:", err);
        alert("Patch trigger failed.");
      } finally {
        patchBtn.disabled = false; patchSpinner.style.display = "none";
      }
    });
  </script>
</body>
</html>
